<!doctype html>
<html lang="en">
 <head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <style>
.x-wrap {
 overflow-wrap: break-word;
}
  </style>

  <title>Average Joes Battery Tester</title>
 </head>
 <body>
  <div class="container-fluid">
   <div class="row">
    <div class="col-3 x-wrap"><p id="BatteryTestReading"></p></div>
    <div class="col-3 x-wrap"><p id="BatteryTestStatus"></p></div>
    <div class="col-3 x-wrap"><p id="StartBatteryTest"></p></div>
    <div class="col-3 x-wrap"><p id="TickTock"></p></div>
   </div>
   <div class="row">
    <div class="col-lg-2">
     Server connection: <div id="connection-state">Disconnected.</div>
    </div>
    <div class="col-lg-2">
     Test Status: <div id="test-status">OFF</div>
    </div>
    <div class="col-lg-2">
     Voltage: <div id="test-voltage"></div>
    </div>
    <div class="col-lg-2">
     Amperage: <div id="test-amperage"></div>
    </div>
    <div class="col-lg-2">
     <div id="time-human"></div>
    </div>
   </div>
   <div class="row">
    <div class="col-lg-1"></div>
    <div class="col-lg-10"><canvas id="voltagechart"></canvas></div>
    <div class="col-lg-1"></div>
   </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.2.1/chart.umd.min.js" integrity="sha512-GCiwmzA0bNGVsp1otzTJ4LWQT2jjGJENLGyLlerlzckNI30moi2EQT0AfRI7fLYYYDKR+7hnuh35r3y1uJzugw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>  <script src="https://code.jquery.com/jquery-3.6.4.slim.min.js" integrity="sha256-a2yjHM4jnF9f54xUQakjZGaqYs/V1CYvWpoqZzC2/Bw=" crossorigin="anonymous"></script>
  <script src="ReconnectingWebsocket.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
  <script src="chart-utils.min.js"></script>
  <script>
var labels = [];
var voltages = [];
var amperages = [];

// https://stackoverflow.com/a/73414958/17887564
const Utils = ChartUtils.init();

const chartData = {
  labels: labels,
  datasets: [
    {
      label: 'Voltage',
      data: voltages,
      borderColor: Utils.CHART_COLORS.red,
      backgroundColor: Utils.transparentize(Utils.CHART_COLORS.red, 0.5),
      yAxisID: 'y',
    }
    ,
    {
      label: 'Amperage',
      data: amperages,
      borderColor: Utils.CHART_COLORS.blue,
      backgroundColor: Utils.transparentize(Utils.CHART_COLORS.blue, 0.5),
      yAxisID: 'y1',
    }
  ]
};

const chartConfig = {
  type: 'line',
  data: chartData,
  options: {
    animation: false,
    responsive: true,
    scales: {
      x: {
        type: 'linear',
        beginAtZero: true,
        ticks: {
          precision: 0
        },
        title: 'Seconds'
      },
      y: {
        type: 'linear',
        title: 'Volts'
      },
      y1: {
        type: 'linear',
        title: 'Amps',
        display: true,
        position: 'right',

        // grid line settings
        grid: {
          drawOnChartArea: false, // only want the grid lines for one axis to show up
        },
      }
    },
    plugins: {
      legend: {
        display: true,
        position: 'top'
      },
      title: {
        display: false,
        text: 'Current battery'
      }
    }
  },
};
const voltageChart = new Chart(document.getElementById('voltagechart'), chartConfig);

var ws = new ReconnectingWebSocket("ws://127.0.0.1:8080/battery");
ws.debug = true;
ws.onmessage = function (event) {
  var data = JSON.parse(event.data);
  $('#' + data.messageType).text(event.data);
  switch (data.messageType) {
    case "BatteryTestReading":
      labels.push(data.payload.time);
      voltages.push(data.payload.voltage);
      amperages.push(data.payload.amperage);
      if (data.payload.update) {
        voltageChart.update();
      }
      $('#test-voltage').text(data.payload.voltage.toFixed(2));
      $('#test-amperage').text(data.payload.amperage.toFixed(2));
      break;
    case "StartBatteryTest":
      labels.length = 0;
      voltages.length = 0;
      amperages.length = 0;
      voltageChart.update();
      break;
    case "TickTock":
      $('#time-human').text(data.payload.human);
      break;
    case "BatteryTestStatus":
      $('#test-status').text(data.payload.status);
      break;
    default:
      break; // should probably log something here
  }
}

ws.onopen = function (event) {
 $('#connection-state').text("Connected.")
}

ws.onclose = function (event) {
 $('#connection-state').text("Disconnected.")
}

  </script>
 </body>
</html>