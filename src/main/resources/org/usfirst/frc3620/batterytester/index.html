<!doctype html>
<html lang="en" class="h-100">
 <head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="bootstrap-5.1.3-dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
.x-wrap {
 overflow-wrap: break-word;
}

/* need this for fixed navbar */
body { padding-top: 40px; }

.bottom-part {
    /* height: calc(100% - max(96px, 20%)); */
    height: calc(100% - 140px);
}
  </style>

  <title>Average Joes Battery Tester</title>
 </head>
 <body class="h-100">
  <nav class="navbar navbar-expand-lg bg-light fixed-top">
   <div class="container-fluid">
    <div class="d-flex">Server connection:&nbsp;<div id="connection-state">Disconnected.</div></div>
    <div class="d-flex">
      Status:&nbsp;<div id="test-status"></div>
      &nbsp;&nbsp;&nbsp;&nbsp;
      V:&nbsp;<div id="test-voltage"></div>
      &nbsp;&nbsp;&nbsp;&nbsp;
      A:&nbsp;<div id="test-amperage"></div>
    </div>
    <div class="d-flex">
     <div id="time-human">&nbsp;</div>
    </div>
   </div>
  </nav>
  <div class="h-100 container-fluid d-flex flex-column">
   <div class="row flex-grow-1">
    <div class="col-lg-1 d-flex flex-column">
     <div class="aligns-items-top">
      <div class="d-flex">
       Battery:&nbsp;<select id="battery"></select>
      </div>
     </div>
     <div class="aligns-items-center">
      <button class="btn btn-success" id="id">Id</button>
      <br/><br/>
      <button class="btn btn-success" id="start">Start</button>
      <br/><br/>
      <button class="btn btn-warning" id="pause">Pause</button>
      <br/><br/>
      <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#stopModal">Stop</button>
     </div>
     <div class="aligns-items-bottom">Bottom</div>
    </div>
    <div class="col-lg-10"><canvas id="voltagechart"></canvas></div>
    <div class="col-lg-1"></div>
   </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="stopModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
   <div class="modal-dialog" role="document">
    <div class="modal-content">
     <div class="modal-header">
      <h5 class="modal-title" id="exampleModalLabel">Stop Test?</h5>
      <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
       <span aria-hidden="true">&times;</span>
      </button>
     </div>
     <div class="modal-body">
      Are you sure you want to stop this test?
     </div>
     <div class="modal-footer">
      <button type="button" id="stop" class="btn btn-danger" data-bs-dismiss="modal">Stop</button>
      <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cancel</button>
     </div>
    </div>
   </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="disconnectedModal" data-bs-backdrop="static" data-bs-keyboard="false" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
   <div class="modal-dialog" role="document">
    <div class="modal-content">
     <div class="modal-body">
      Waiting for server connection...
     </div>
    </div>
   </div>
  </div>

  <script src="chart.js-4.2.1/chart.umd.js"></script>
  <script src="jquery-3.6.4.min.js"></script>
  <script src="bootstrap-5.1.3-dist/js/bootstrap.min.js"></script>

  <!-- https://github.com/joewalnes/reconnecting-websocket -->
  <script src="ReconnectingWebsocket.js"></script>

  <!-- https://github.com/imhvost/chart-utils/blob/master/dist/chart-utils.min.js -->
  <script src="chart-utils.min.js"></script>

  <script>
var labels = [];
var voltages = [];
var amperages = [];

// https://stackoverflow.com/a/73414958/17887564
const Utils = ChartUtils.init();

const chartData = {
 labels: labels,
 datasets: [
  {
   label: 'Voltage',
   data: voltages,
   borderColor: Utils.CHART_COLORS.red,
   backgroundColor: Utils.transparentize(Utils.CHART_COLORS.red, 0.5),
   yAxisID: 'y',
  }
  ,
  {
   label: 'Amperage',
   data: amperages,
   borderColor: Utils.CHART_COLORS.blue,
   backgroundColor: Utils.transparentize(Utils.CHART_COLORS.blue, 0.5),
   yAxisID: 'y1',
  }
 ]
};

const chartConfig = {
 type: 'line',
 data: chartData,
 options: {
  animation: false,
  responsive: true,
  maintainAspectRatio: false,
  scales: {
   x: {
    type: 'linear',
    beginAtZero: true,
    ticks: {
     precision: 0
    },
    title: {
     text: 'Seconds',
     display: true
    }
   },
   y: {
    type: 'linear',
    title: {
     text: 'Volts',
     display: true
    }
   },
   y1: {
    type: 'linear',
    title: {
     text: 'Amps',
     display: true
    },
    position: 'right',

    // grid line settings
    grid: {
     drawOnChartArea: false, // only want the grid lines for one axis to show up
    },
   }
  },
  plugins: {
   legend: {
    display: true,
    position: 'top'
   },
   title: {
    display: false,
    text: 'Current battery'
   }
  }
 },
};
const voltageChart = new Chart(document.getElementById('voltagechart'), chartConfig);

// these need work; they will get squirrelly if we disable button based on tests start and stop
function showConnect() {
 $('#connection-state').text("Connected.")
 $('#connection-state').removeClass("text-danger");
 $('#connection-state').addClass("text-success");
}

function showDisconnect() {
 $('#connection-state').text("Disconnected.");
 $('#connection-state').removeClass("text-success");
 $('#connection-state').addClass("text-danger");
}

function ajaxButton(url) {
 // console.log("ajaxButton hit for " + url);
 $.get(url)
  .done(function(data, status, jqXHR){
   // alert("Data: " + data + "\nStatus: " + status + "\njqXHR: " + jqXHR);
  })
  .fail(function(jqXHR, status, data){
   alert("Data: " + jqXHR.responseText + "\nStatus: " + status + "\njqXHR: " + jqXHR);
  });
}

$("#id").click(function() { ajaxButton("/test/id"); });
$("#start").click(function() { ajaxButton("/test/start"); });
$("#stop").click(function() { ajaxButton("/test/stop"); });
$("#pause").click(function() { ajaxButton("/test/pause"); });

$( document ).ready(function() {
 showDisconnect();

 var ws = new ReconnectingWebSocket("ws://" + location.host + "/battery");
 ws.debug = false;
 ws.onmessage = function (event) {
   var data = JSON.parse(event.data);
   // console.log(event.data);
   $('#' + data.messageType).text(event.data);
   switch (data.messageType) {
     case "BatteryReading":
       $('#test-voltage').text(data.payload.voltage.toFixed(2));
       $('#test-amperage').text(data.payload.amperage.toFixed(2));
       break;
     case "BatteryTestReading":
       labels.push(data.payload.time);
       voltages.push(data.payload.voltage);
       amperages.push(data.payload.amperage);
       if (data.payload.update) {
         voltageChart.update();
       }
       $('#test-voltage').text(data.payload.voltage.toFixed(2));
       $('#test-amperage').text(data.payload.amperage.toFixed(2));
       break;
     case "StartBatteryTest":
       labels.length = 0;
       voltages.length = 0;
       amperages.length = 0;
       voltageChart.update();
       break;
     case "TickTock":
       $('#time-human').text(data.payload.human);
       break;
     case "BatteryTestStatus":
       $('#test-status').text(data.payload.status);
       break;
     default:
       break; // should probably log something here
   }
 }

 ws.onopen = function (event) {
  showConnect();
  $('#disconnectedModal').modal('hide');
 }

 ws.onclose = function (event) {
  showDisconnect();
  $('#disconnectedModal').modal('show');
 }

});

  </script>
 </body>
</html>