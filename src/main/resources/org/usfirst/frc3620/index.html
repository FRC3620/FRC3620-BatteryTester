<!doctype html>
<html lang="en">
 <head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

  <title>Average Joes Battery Tester</title>
 </head>
 <body>
  <div><canvas id="voltagechart"></canvas></div>
  <div id="lastmessage"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.2.1/chart.umd.min.js" integrity="sha512-GCiwmzA0bNGVsp1otzTJ4LWQT2jjGJENLGyLlerlzckNI30moi2EQT0AfRI7fLYYYDKR+7hnuh35r3y1uJzugw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>  <script src="https://code.jquery.com/jquery-3.6.4.slim.min.js" integrity="sha256-a2yjHM4jnF9f54xUQakjZGaqYs/V1CYvWpoqZzC2/Bw=" crossorigin="anonymous"></script>
  <script src="ReconnectingWebsocket.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
  <script src="chart-utils.min.js"></script>
  <script>
var labels = [];
var voltages = [];
var amperages = [];

// https://stackoverflow.com/a/73414958/17887564
const Utils = ChartUtils.init();

const chartData = {
  labels: labels,
  datasets: [
    {
      label: 'Voltage',
      data: voltages,
      borderColor: Utils.CHART_COLORS.red,
      backgroundColor: Utils.transparentize(Utils.CHART_COLORS.red, 0.5),
    }
  ]
};

const chartConfig = {
  type: 'line',
  data: chartData,
  options: {
    responsive: true,
    plugins: {
      legend: {
        position: 'top',
      },
      title: {
        display: true,
        text: 'Chart.js Line Chart'
      }
    }
  },
};
const voltageChart = new Chart(document.getElementById('voltagechart'), chartConfig);

var ws = new ReconnectingWebSocket("ws://127.0.0.1:8080/battery");
ws.debug = true;
ws.onmessage = function (event) {
    var messageFromServer = event;
    $('#lastmessage').text(event.data);
    var data = JSON.parse(event.data);
    labels.push(data.payload.time);
    voltages.push(data.payload.voltage);
    voltageChart.update();
}

ws.onopen = function (event) {
}

ws.onclose = function (event) {
}

  </script>
 </body>
</html>